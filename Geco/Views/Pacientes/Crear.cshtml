@model Entities.CrearPacienteDto

@{
    ViewData["Title"] = "Nuevo Paciente";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-person-plus"></i> Nuevo Paciente
                    </h4>
                </div>
                <div class="card-body">
                    <form asp-action="Crear" method="post">
                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger">
                                @Html.ValidationSummary(false, "", new { @class = "mb-0" })
                            </div>
                        }

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Los campos marcados con <strong>*</strong> son obligatorios
                        </div>

                        <h5 class="mb-3"><i class="bi bi-person"></i> Datos Personales</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Nombre" class="form-label">Nombre *</label>
                                <input asp-for="Nombre" class="form-control" required autofocus />
                                <span asp-validation-for="Nombre" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Apellido" class="form-label">Apellido *</label>
                                <input asp-for="Apellido" class="form-control" required />
                                <span asp-validation-for="Apellido" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label asp-for="TipoDocumento" class="form-label">Tipo Doc *</label>
                                <select asp-for="TipoDocumento" class="form-select" required>
                                    <option value="DNI" selected>DNI</option>
                                    <option value="LC">LC</option>
                                    <option value="LE">LE</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="NumeroDocumento" class="form-label">Número Doc *</label>
                                <input asp-for="NumeroDocumento" class="form-control" required />
                                <span asp-validation-for="NumeroDocumento" class="text-danger"></span>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="FechaNacimiento" class="form-label">Fecha Nac.</label>
                                <input asp-for="FechaNacimiento" class="form-control" type="date" />
                            </div>

                            <div class="col-md-3 mb-3">
                                <label asp-for="Sexo" class="form-label">Sexo</label>
                                <select asp-for="Sexo" class="form-select">
                                    <option value="">-- Seleccionar --</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Femenino">Femenino</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                        </div>

                        <hr class="my-4" />
                        <h5 class="mb-3"><i class="bi bi-telephone"></i> Contacto</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Telefono" class="form-label">Teléfono</label>
                                <input asp-for="Telefono" class="form-control" type="tel" />
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="TelefonoAlternativo" class="form-label">Tel. Alternativo</label>
                                <input asp-for="TelefonoAlternativo" class="form-control" type="tel" />
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="Email" class="form-label">Email</label>
                                <input asp-for="Email" class="form-control" type="email" />
                            </div>
                        </div>

                        <hr class="my-4" />
                        <h5 class="mb-3"><i class="bi bi-geo-alt"></i> Domicilio</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Direccion" class="form-label">Dirección</label>
                                <input asp-for="Direccion" class="form-control" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Localidad" class="form-label">Localidad</label>
                                <input asp-for="Localidad" class="form-control" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Provincia" class="form-label">Provincia</label>
                                <input asp-for="Provincia" class="form-control" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="CodigoPostal" class="form-label">Código Postal</label>
                                <input asp-for="CodigoPostal" class="form-control" />
                            </div>
                        </div>

                        <hr class="my-4" />
                        <h5 class="mb-3"><i class="bi bi-shield-check"></i> Cobertura Médica *</h5>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Primero seleccione la <strong>Obra Social</strong>, luego el sistema cargará automáticamente los planes disponibles.
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="ObraSocialId" class="form-label">
                                    Obra Social *
                                    <small class="text-muted">(Paso 1)</small>
                                </label>
                                <select name="ObraSocialId"
                                        id="ObraSocialId"
                                        asp-items="ViewBag.ObrasSociales"
                                        class="form-select"
                                        data-val="true"
                                        data-val-required="La obra social es requerida"
                                        required>
                                    <option value="">-- Seleccionar --</option>
                                </select>
                                <span asp-validation-for="ObraSocialId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="PlanId" class="form-label">
                                    Plan *
                                    <small class="text-muted">(Paso 2)</small>
                                </label>
                                <select name="PlanId"
                                        id="PlanId"
                                        class="form-select"
                                        data-val="true"
                                        data-val-required="El plan es requerido"
                                        required>
                                    <option value="">-- Seleccionar obra social primero --</option>
                                </select>
                                <span asp-validation-for="PlanId" class="text-danger"></span>
                                <small class="form-text text-muted" id="planHelpText">
                                    Los planes se cargarán al seleccionar una obra social
                                </small>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="NumeroAfiliado" class="form-label">Nº Afiliado</label>
                                <input asp-for="NumeroAfiliado" class="form-control" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Observaciones" class="form-label">Observaciones</label>
                            <textarea asp-for="Observaciones"
                                      class="form-control"
                                      rows="3"
                                      placeholder="Información adicional del paciente (opcional)"></textarea>
                            <small class="form-text text-muted">Campo opcional</small>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> Guardar Paciente
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Dropdown en cascada: cuando cambia la obra social, cargar los planes
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando dropdown de planes...');

            // IMPORTANTE: Remover completamente cualquier validación del campo Observaciones
            var observacionesField = document.querySelector('textarea[name="Observaciones"]');
            if (observacionesField) {
                observacionesField.removeAttribute('required');
                observacionesField.removeAttribute('data-val');
                observacionesField.removeAttribute('data-val-required');
                observacionesField.removeAttribute('aria-required');
                // Eliminar las reglas de jQuery Validation si existen
                if (typeof $.validator !== 'undefined') {
                    $(observacionesField).rules('remove');
                }
            }

            // Buscar el select de obra social por múltiples métodos para asegurar que lo encontramos
            var obraSocialSelect = document.getElementById('ObraSocialId')
                || document.querySelector('select[name="ObraSocialId"]');

            var planSelect = document.getElementById('PlanId')
                || document.querySelector('select[name="PlanId"]');

            console.log('Obra Social Select encontrado:', obraSocialSelect ? 'SI' : 'NO');
            console.log('Plan Select encontrado:', planSelect ? 'SI' : 'NO');

            if (!obraSocialSelect || !planSelect) {
                console.error('ERROR: No se pudieron encontrar los selectores');
                console.log('Todos los selects en la página:', document.querySelectorAll('select'));
                return;
            }

            console.log('ID del select de obra social:', obraSocialSelect.id);
            console.log('Name del select de obra social:', obraSocialSelect.name);

            // Si ya hay una obra social seleccionada (por ejemplo, al retornar por error de validación)
            // cargar los planes correspondientes
            var obraSocialIdInicial = obraSocialSelect.value;
            console.log('Valor inicial de obra social:', obraSocialIdInicial);
            if (obraSocialIdInicial) {
                cargarPlanes(obraSocialIdInicial);
            }

            // Agregar el evento change con logging
            obraSocialSelect.addEventListener('change', function(e) {
                console.log('Evento change detectado en obra social');
                console.log('Valor seleccionado:', this.value);
                var obraSocialId = this.value;
                if (obraSocialId) {
                    cargarPlanes(obraSocialId);
                } else {
                    console.log('No se seleccionó ninguna obra social');
                    planSelect.innerHTML = '<option value="">-- Seleccionar obra social primero --</option>';
                    planSelect.disabled = false;
                }
            });

            console.log('Event listener agregado exitosamente');

            function cargarPlanes(obraSocialId) {
                var planHelpText = document.getElementById('planHelpText');

                if (!obraSocialId) {
                    planSelect.innerHTML = '<option value="">-- Seleccionar obra social primero --</option>';
                    planSelect.disabled = false;
                    if (planHelpText) {
                        planHelpText.textContent = 'Los planes se cargarán al seleccionar una obra social';
                        planHelpText.className = 'form-text text-muted';
                    }
                    return;
                }

                // Guardar el valor seleccionado actualmente (si existe)
                var planSeleccionado = planSelect.value;

                // Limpiar el select de planes
                planSelect.innerHTML = '<option value="">Cargando...</option>';
                planSelect.disabled = true;

                if (planHelpText) {
                    planHelpText.textContent = 'Cargando planes disponibles...';
                    planHelpText.className = 'form-text text-primary';
                }

                // Hacer request AJAX para obtener los planes
                console.log('Cargando planes para obra social ID:', obraSocialId);
                fetch('/Pacientes/ObtenerPlanesPorObraSocial?obraSocialId=' + obraSocialId)
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Error HTTP ' + response.status + ': ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Planes recibidos:', data);

                        // Verificar si hay un error en la respuesta
                        if (data.error) {
                            console.error('Error del servidor:', data.mensaje);
                            planSelect.innerHTML = '<option value="">Error: ' + data.mensaje + '</option>';
                            planSelect.disabled = false;
                            alert('Error al cargar los planes:\n\n' + data.mensaje + '\n\nPor favor, verifique:\n1. Que la base de datos esté accesible\n2. Que los stored procedures estén creados\n3. Que la obra social tenga planes configurados\n\nRevise la consola del servidor para más detalles.');
                            return;
                        }

                        planSelect.innerHTML = '<option value="">-- Seleccionar plan --</option>';

                        if (data && Array.isArray(data) && data.length > 0) {
                            console.log('Se encontraron', data.length, 'planes');
                            data.forEach(function(plan) {
                                var option = document.createElement('option');
                                option.value = plan.value;
                                option.text = plan.text;
                                // Mantener la selección anterior si existe
                                if (plan.value == planSeleccionado) {
                                    option.selected = true;
                                }
                                planSelect.appendChild(option);
                            });

                            if (planHelpText) {
                                planHelpText.textContent = data.length + ' plan(es) disponible(s)';
                                planHelpText.className = 'form-text text-success';
                            }
                        } else {
                            console.warn('No se encontraron planes para esta obra social');
                            planSelect.innerHTML = '<option value="">No hay planes configurados para esta obra social</option>';

                            if (planHelpText) {
                                planHelpText.textContent = 'No hay planes configurados para esta obra social';
                                planHelpText.className = 'form-text text-warning';
                            }
                        }

                        planSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error al cargar planes:', error);
                        planSelect.innerHTML = '<option value="">Error de conexión</option>';
                        planSelect.disabled = false;

                        if (planHelpText) {
                            planHelpText.textContent = 'Error al cargar planes. Ver consola para detalles.';
                            planHelpText.className = 'form-text text-danger';
                        }

                        alert('Error al cargar los planes:\n\n' + error.message + '\n\nPosibles causas:\n1. Problema de conexión con el servidor\n2. Los stored procedures de Planes no están creados en la base de datos\n3. La obra social no tiene planes configurados\n\nPor favor, ejecute el script SQL/Instalacion_Completa.sql en su base de datos.');
                    });
            }
        });
    </script>
}