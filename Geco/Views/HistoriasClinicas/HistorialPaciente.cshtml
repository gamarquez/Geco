@model List<Entities.HistoriaClinicaDto>

@{
    ViewData["Title"] = "Historial del Paciente";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-file-medical"></i> Historial Clínico</h2>
            <h5 class="text-muted">@ViewBag.PacienteNombre</h5>
            <p class="text-muted">Documento: @ViewBag.PacienteDocumento</p>
        </div>
        <div class="col-md-4 text-end">
            <a asp-action="Crear" asp-route-pacienteId="@ViewBag.PacienteId" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Nueva Consulta
            </a>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    @if (TempData["Mensaje"] != null)
    {
        <div class="alert alert-@TempData["TipoMensaje"] alert-dismissible fade show" role="alert">
            @TempData["Mensaje"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        <!-- Timeline de consultas -->
        <div class="timeline">
            @foreach (var historia in Model)
            {
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-check text-primary"></i>
                                    @historia.FechaConsulta.ToString("dd/MM/yyyy HH:mm")
                                </h5>
                                <small class="text-muted">
                                    <i class="bi bi-person-badge"></i> @historia.ProfesionalNombreCompleto
                                    (Mat: @historia.ProfesionalMatricula)
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group" role="group">
                                    <a asp-action="Detalle" asp-route-id="@historia.HistoriaClinicaId"
                                       class="btn btn-sm btn-info" title="Ver detalles">
                                        <i class="bi bi-eye"></i> Ver Completo
                                    </a>
                                    <a asp-action="Editar" asp-route-id="@historia.HistoriaClinicaId"
                                       class="btn btn-sm btn-warning" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Columna izquierda: Datos clínicos -->
                            <div class="col-md-8">
                                <p class="mb-2">
                                    <strong><i class="bi bi-chat-left-text text-info"></i> Motivo:</strong>
                                    @historia.MotivoConsulta
                                </p>

                                <p class="mb-2">
                                    <strong><i class="bi bi-clipboard-check text-warning"></i> Diagnóstico:</strong>
                                    <span class="text-primary">@historia.Diagnostico</span>
                                </p>

                                @if (!string.IsNullOrWhiteSpace(historia.Tratamiento))
                                {
                                    <p class="mb-2">
                                        <strong><i class="bi bi-capsule text-success"></i> Tratamiento:</strong>
                                        @if (historia.Tratamiento.Length > 150)
                                        {
                                            <span>@historia.Tratamiento.Substring(0, 150)... <a asp-action="Detalle" asp-route-id="@historia.HistoriaClinicaId">Ver más</a></span>
                                        }
                                        else
                                        {
                                            <span>@historia.Tratamiento</span>
                                        }
                                    </p>
                                }
                            </div>

                            <!-- Columna derecha: Signos vitales -->
                            <div class="col-md-4">
                                @if (historia.Peso.HasValue || historia.Altura.HasValue || historia.PresionArterial.HasValue ||
                                      historia.Temperatura.HasValue || historia.FrecuenciaCardiaca.HasValue)
                                {
                                    <div class="card bg-light">
                                        <div class="card-body p-2">
                                            <h6 class="card-title mb-2 text-center">
                                                <i class="bi bi-heart-pulse text-danger"></i> Signos Vitales
                                            </h6>
                                            <div class="small">
                                                @if (historia.Peso.HasValue)
                                                {
                                                    <p class="mb-1">
                                                        <strong>Peso:</strong> @historia.Peso.Value.ToString("0.##") kg
                                                    </p>
                                                }
                                                @if (historia.Altura.HasValue)
                                                {
                                                    <p class="mb-1">
                                                        <strong>Altura:</strong> @historia.Altura.Value.ToString("0.##") m
                                                    </p>
                                                }
                                                @if (historia.Peso.HasValue && historia.Altura.HasValue && historia.IMC.HasValue)
                                                {
                                                    <p class="mb-1">
                                                        <strong>IMC:</strong>
                                                        <span class="badge bg-info">@historia.IMC.Value.ToString("0.##")</span>
                                                    </p>
                                                }
                                                @if (historia.PresionArterial.HasValue)
                                                {
                                                    <p class="mb-1">
                                                        <strong>Presión:</strong> @historia.PresionArterial.Value.ToString("0.##") mmHg
                                                    </p>
                                                }
                                                @if (historia.Temperatura.HasValue)
                                                {
                                                    <p class="mb-1">
                                                        <strong>Temp:</strong> @historia.Temperatura.Value.ToString("0.#") °C
                                                    </p>
                                                }
                                                @if (historia.FrecuenciaCardiaca.HasValue)
                                                {
                                                    <p class="mb-1">
                                                        <strong>FC:</strong> @historia.FrecuenciaCardiaca.Value.ToString("0.##") lpm
                                                    </p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white">
                        <small class="text-muted">
                            <i class="bi bi-clock-history"></i> Registrado: @historia.FechaAlta.ToString("dd/MM/yyyy HH:mm")
                        </small>
                    </div>
                </div>
            }
        </div>

        <div class="mt-3">
            <p class="text-muted">Total de consultas: <strong>@Model.Count</strong></p>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i>
            <h5>No hay historias clínicas registradas para este paciente</h5>
            <p>Este paciente aún no tiene consultas registradas en el sistema.</p>
            <a asp-action="Crear" asp-route-pacienteId="@ViewBag.PacienteId" class="btn btn-primary mt-2">
                <i class="bi bi-plus-circle"></i> Registrar Primera Consulta
            </a>
        </div>
    }
</div>

@section Styles {
    <style>
        .timeline {
            position: relative;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
    </style>
}
